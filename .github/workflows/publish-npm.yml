name: Publish Current Version to NPM

on:
  workflow_dispatch:
    inputs:
      force_publish:
        description: 'Force publish even if version exists on NPM'
        required: true
        type: boolean
        default: false

jobs:
  publish-current:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        registry-url: 'https://registry.npmjs.org'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm test
    
    - name: Build project
      run: npm run build
    
    - name: Check current version
      id: version
      run: |
        VERSION=$(node -p "require('./package.json').version")
        echo "Current version: $VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
    
    - name: Check if version exists on NPM
      id: npm_check
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        if npm view colorjslogger@$VERSION version 2>/dev/null; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "⚠️ Version $VERSION already exists on NPM"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "✅ Version $VERSION does not exist on NPM"
        fi
    
    - name: Publish to NPM
      if: steps.npm_check.outputs.exists == 'false' || github.event.inputs.force_publish == 'true'
      run: |
        echo "🚀 Publishing version ${{ steps.version.outputs.version }} to NPM..."
        npm publish
        echo "✅ Successfully published to NPM!"
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    
    - name: Skip publishing
      if: steps.npm_check.outputs.exists == 'true' && github.event.inputs.force_publish == 'false'
      run: |
        echo "⏭️ Skipping publish - version ${{ steps.version.outputs.version }} already exists on NPM"
        echo "💡 To force publish, run this workflow again with force_publish=true"